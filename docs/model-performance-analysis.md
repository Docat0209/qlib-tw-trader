# 模型訓練與回測深度分析報告

**生成時間**：2026-02-06
**回測期間**：2025W01 ~ 2026W01（52 週）
**股票池**：TW100（台股市值前 100 大）

---

## 執行摘要

### 核心結論

1. **訓練效果優秀**：Valid ICIR = 1.85，遠超 0.5 基準，訓練穩定可靠
2. **實盤預測能力存疑**：Live IC p = 0.24，無法確認預測能力統計顯著
3. **但超額報酬顯著**：累積 87% 超額報酬，p = 0.002
4. **ICIR 衰減嚴重**：91% 衰減（1.85 → 0.17），穩定性大幅下降
5. **需更多數據**：確認 Live IC 顯著至少需要 96 週

### 風險警示

- Live IC 的 95% 信賴區間 [-0.007, 0.027] **包含 0**
- Valid-Live IC 相關性為 **-0.20**，驗證期無法預測實盤表現
- IC Decay 存在極端離群值（-3451%），單週評估不可靠

### 建議行動

1. **繼續累積數據**：至少再觀察 44 週（達到 96 週）
2. **改進驗證方法**：縮短驗證期，減少與實盤環境差異
3. **監控 ICIR**：用 5 週滾動 ICIR 替代單週 IC

---

## 1. 計算方式說明

### 1.1 我們的 IC 定義

| 項目 | 實現方式 | 代碼位置 |
|------|---------|---------|
| **相關方法** | Spearman 秩相關 | `model_trainer.py:616` |
| **計算頻率** | 每日截面 → 取平均 | `groupby("datetime")` |
| **Label 定義** | `close[T+2]/close[T+1] - 1` | `model_trainer.py:256` |
| **Label 標準化** | CSRankNorm（排名百分位 [0,1]） | `model_trainer.py:314` |
| **最小股票數** | 10 支 | `if len(group) < 10: return nan` |

**計算公式**：
```
IC = E[Spearman(預測排名, 實際排名)]
   = 平均(每日截面的 Spearman 相關係數)
```

### 1.2 與文獻定義的差異

| 定義來源 | 相關方法 | 頻率 | Label | 可比較性 |
|---------|---------|------|-------|---------|
| **Grinold & Kahn** | Pearson | 年級 | 原始收益 | ❌ 不可比 |
| **Qlib 論文** | Spearman | 日級 | 原始收益 | ⚠️ 部分可比 |
| **我們** | Spearman | 日級 | 排名標準化 | - |

### 1.3 定義差異的數值影響

| 差異來源 | 對 IC 數值的影響 |
|---------|-----------------|
| Spearman vs Pearson | Spearman ↑ 5-15%（對離群值更穩健） |
| 日級 vs 年級 | 日級 ↓ 50-70%（噪音更多） |
| 排名 vs 收益 | 排名預測可提升 Sharpe 3 倍 |

**關鍵結論**：
- 我們的 IC 數值**不能直接與年級 IC 比較**
- 日級 IC 0.01-0.03 ≈ 年級 IC 0.03-0.10（等效換算）
- 應使用 **ICIR**（去隨機性指標）而非絕對 IC 值比較

---

## 2. 數據概覽（統計可信度指標）

### 2.1 IC 統計摘要

| 指標 | Valid IC | Live IC | 差異說明 |
|------|----------|---------|---------|
| **平均值** | 0.0273 | 0.0102 | Live 降低 62.5% |
| **標準差** | 0.0147 | 0.0608 | Live 波動大 4.1 倍 |
| **ICIR** | **1.85** | **0.17** | 關鍵差異！ |
| **正值比例** | 94.2% | 66.0% | |
| **中位數** | 0.0289 | 0.0186 | |
| **Q1-Q3** | [0.019, 0.038] | [-0.022, 0.052] | Live 範圍更廣 |
| **最小值** | -0.006 | -0.163 | Live 有大負值 |
| **最大值** | 0.060 | 0.112 | |

### 2.2 統計顯著性檢驗

| 假設檢驗 | t 統計量 | p 值 | 結論 |
|---------|---------|------|------|
| Valid IC > 0 | 13.36 | < 0.001 | ✅ **高度顯著** |
| Live IC > 0 | 1.19 | 0.240 | ❌ 不顯著 |
| 超額報酬 > 0 | 3.22 | 0.002 | ✅ **顯著** |

**Live IC 95% 信賴區間**：[-0.007, 0.027]
- 區間**包含 0**，無法排除 Live IC = 0 的可能性

### 2.3 與文獻基準的正確比較

使用 **ICIR**（去隨機性）而非絕對 IC 值：

| 指標 | 我們的值 | 文獻基準 | 可比較？ | 評價 |
|------|---------|---------|---------|------|
| **Valid ICIR** | 1.85 | > 0.5 (Grinold) | ✅ 是 | ✅ **優秀** |
| **Live ICIR** | 0.17 | > 0.5 (Grinold) | ✅ 是 | ❌ **不穩定** |
| Live IC p 值 | 0.24 | < 0.05 | ✅ 是 | ❌ 不顯著 |
| 正值比例 | 66% | > 50% | ✅ 是 | ⚠️ 邊緣 |

**ICIR 文獻基準**（Grinold & Kahn, 2000）：
- ICIR > 0.5：可用（usable）
- ICIR > 1.0：優秀（excellent）
- ICIR > 2.0：非常優秀

---

## 3. IC Decay 深度分析

### 3.1 Decay 的統計特性

| 統計量 | 數值 | 說明 |
|--------|------|------|
| **平均 Decay** | -33% | 被極端值拉低 |
| **中位數 Decay** | 40% | 更具代表性 |
| **標準差** | 592% | 極高波動 |
| **最小值** | -3451% | 極端離群值 |
| **最大值** | 917% | |
| **Valid-Live 相關** | -0.20 | 近乎無關 |

### 3.2 高波動是否「正常」？

**是正常的**，原因如下：

1. **Live IC 波動是 Valid IC 的 4 倍**
   - Valid IC std = 0.015
   - Live IC std = 0.061
   - 波動比 = 4.1x

2. **Decay 公式的數學特性**
   ```
   Decay = (Valid - Live) / Valid × 100%
   ```
   - 當 Valid IC 很小（如 0.01）且 Live IC 為負（如 -0.05）時
   - Decay = (0.01 - (-0.05)) / 0.01 = 600%
   - 小分母會放大百分比

3. **市場狀態變化**
   - 驗證期的市場模式不保證在實盤期重現
   - 這是金融市場的本質，非模型缺陷

### 3.3 正確的評估方式

| 錯誤做法 | 正確做法 |
|---------|---------|
| ❌ 看單週 IC Decay | ✅ 看 ICIR 衰減（91%） |
| ❌ 看平均 Decay | ✅ 看中位數 Decay（40%） |
| ❌ 比較絕對 IC 值 | ✅ 比較 ICIR 和 p 值 |

**文獻基準**（López de Prado, 2018）：
- IC Decay < 30%：良好
- IC Decay 30-50%：可接受
- IC Decay > 50%：需關注

**我們的狀況**：中位數 Decay 40%，在「可接受」範圍

---

## 4. 過擬合診斷

### 4.1 ICIR 衰減分析

```
ICIR 衰減 = (Valid ICIR - Live ICIR) / Valid ICIR
         = (1.85 - 0.17) / 1.85
         = 90.9%
```

**這比 IC 值衰減（62.5%）更嚴重**，因為：
- Valid IC 不僅平均值高，而且**穩定**（std = 0.015）
- Live IC 平均值低，而且**不穩定**（std = 0.061）
- **穩定性的衰減比幅度的衰減更重要**

### 4.2 IC 弱但報酬強的矛盾

| 現象 | 數值 | 可能解釋 |
|------|------|---------|
| Live IC 不顯著 | p = 0.24 | 排名預測精度不足 |
| 超額報酬顯著 | p = 0.002 | Top-K 選股放大微弱信號 |
| 市場報酬高 | 53% | 牛市放大正確方向 |

**Top-K 放大效應**：
- 即使 IC 只有 0.01，只要方向正確
- Top-10 選股會挑到略好於平均的股票
- 累積 52 週後產生顯著超額報酬

### 4.3 診斷結論

| 診斷項目 | 閾值 | 我們的值 | 結論 |
|---------|------|---------|------|
| Valid ICIR | > 0.5 | 1.85 | ✅ 優秀 |
| Live ICIR | > 0.5 | 0.17 | ❌ **失敗** |
| ICIR 衰減 | < 50% | 91% | ❌ **嚴重** |
| Live IC p | < 0.05 | 0.24 | ❌ 不顯著 |
| 超額報酬 p | < 0.05 | 0.002 | ✅ 顯著 |

**過擬合程度**：中度至嚴重
- 訓練表現優秀 ≠ 實盤表現優秀
- 但超額報酬仍統計顯著，說明模型不是完全無效

---

## 5. 所需樣本量估計

### 5.1 確認 Live IC 顯著需要多少週？

**已知**：
- Live IC mean = 0.0102
- Live IC std = 0.0608
- Live ICIR = 0.17

**公式**：
```
n = (z_α / ICIR)²
n = (1.645 / 0.17)² = 96 週
```

**結論**：需要 **96 週**（約 1.8 年）才能達到 p < 0.05

### 5.2 達到 80% 檢定力需要多少週？

```
n = [(z_α + z_β) / ICIR]²
n = [(1.645 + 0.84) / 0.17]² = 218 週
```

**結論**：需要 **218 週**（約 4.2 年）才有 80% 把握確認效果

### 5.3 目前 52 週是否足夠？

| 問題 | 當前 n | 需要 n | 結論 |
|------|--------|--------|------|
| Live IC > 0？ | 52 | 96 | ❌ **不足** |
| 超額報酬 > 0？ | 52 | ~30 | ✅ 足夠 |
| Valid IC > 0？ | 52 | ~10 | ✅ 足夠 |

---

## 6. 優秀與不足分析

### 6.1 哪裡優秀？為什麼？

| 項目 | 數值 | 為什麼優秀 |
|------|------|-----------|
| **Valid ICIR** | 1.85 | 遠超 0.5 基準，訓練穩定 |
| **Valid IC 正值率** | 94.2% | 幾乎每週訓練都有效 |
| **超額報酬** | 87.25% | 統計顯著 (p=0.002) |
| **勝週率** | 63.3% | 顯著超過隨機 50% |
| **年化 Sharpe** | 3.32 | 優秀水準 |

**優秀的根本原因**：
1. 訓練方法正確（Spearman + CSRankNorm）
2. 因子池豐富（266 個因子）
3. 正則化充分（L1/L2 + Early Stopping）

### 6.2 哪裡不足？為什麼？

| 項目 | 數值 | 為什麼不足 |
|------|------|-----------|
| **Live ICIR** | 0.17 | 遠低於 0.5 基準 |
| **Live IC p 值** | 0.24 | 無法確認預測能力 |
| **ICIR 衰減** | 91% | 穩定性大幅下降 |
| **Valid-Live 相關** | -0.20 | 驗證無法預測實盤 |

**不足的根本原因**：

| 問題 | 根本原因 | 證據 |
|------|---------|------|
| Live ICIR 低 | 市場微觀結構噪音大 | Live IC std = 0.061 |
| ICIR 衰減大 | 驗證期與實盤差異 | Valid-Live 相關 = -0.20 |
| | 驗證期 100 天太長 | 市場已變化 |
| | 可能存在過擬合 | ICIR 衰減 91% |

---

## 7. 改進方案

### 7.1 短期措施（1-2 週）

| 措施 | 預期效果 | 風險 |
|------|---------|------|
| 縮短驗證期 100 → 30 天 | ICIR 衰減 ↓ | 驗證樣本過少 |
| 增加 Embargo 7 → 14 天 | 減少 lookahead | 減少訓練數據 |
| 監控 5 週滾動 ICIR | 更快發現問題 | 無 |

### 7.2 中期架構改進（1-2 月）

| 措施 | 預期效果 | 實現複雜度 |
|------|---------|-----------|
| 增量學習（每日微調） | Live IC 穩定性 ↑ | 中 |
| Purged K-Fold 驗證 | 減少過擬合 | 高 |
| 動態因子權重 | 適應市場變化 | 中 |

### 7.3 長期研究方向（3-6 月）

| 措施 | 預期效果 | 實現複雜度 |
|------|---------|-----------|
| Ensemble 多模型組合 | 降低單模型風險 | 高 |
| Online Learning | 實時適應市場 | 很高 |
| 因子輪換機制 | 淘汰失效因子 | 中 |

---

## 8. 結論

### 8.1 整體評價

| 面向 | 評價 | 說明 |
|------|------|------|
| **訓練品質** | ⭐⭐⭐⭐⭐ | Valid ICIR 1.85，優秀 |
| **實盤預測** | ⭐⭐ | Live ICIR 0.17，不穩定 |
| **實際報酬** | ⭐⭐⭐⭐ | 超額報酬顯著 |
| **統計可信度** | ⭐⭐⭐ | 報酬可信，IC 待確認 |

### 8.2 核心洞察

1. **模型有效但不穩定**
   - 超額報酬顯著證明模型有價值
   - 但 Live IC 不穩定表明預測精度有限

2. **IC 不是唯一指標**
   - IC 衡量排名相關性
   - Top-K 策略可以放大微弱但正確的信號

3. **樣本量是關鍵**
   - 52 週足以確認超額報酬
   - 但不足以確認 Live IC 顯著
   - 需繼續累積數據

### 8.3 下一步行動

1. **持續觀察**：至少再累積 44 週（達到 96 週）
2. **監控指標**：用 5 週滾動 ICIR 追蹤
3. **改進驗證**：縮短驗證期減少過擬合
4. **風險控制**：在確認 Live IC 顯著前，謹慎調整倉位

---

## 附錄

### A. IC 計算代碼位置

| 功能 | 檔案 | 行號 |
|------|------|------|
| Label 定義 | `model_trainer.py` | 256 |
| Label 標準化 | `model_trainer.py` | 314, 372 |
| IC 計算（訓練） | `model_trainer.py` | 613-618 |
| IC 計算（Live） | `walk_forward_backtester.py` | 476-481 |
| ICIR 計算 | `model_trainer.py` | 1167-1176 |

### B. 文獻引用

1. **Grinold, R. C., & Kahn, R. N. (2000)**. *Active Portfolio Management*. McGraw-Hill.
   - IC/ICIR 標準定義
   - ICIR > 0.5 為可用基準

2. **Microsoft Qlib (2020)**. *Qlib: An AI-oriented Quantitative Investment Platform*. arXiv:2009.11189.
   - 日級 Spearman IC
   - CSRankNorm 標準化

3. **Poh, D., et al. (2021)**. *Building Cross-Sectional Systematic Strategies By Learning to Rank*. Journal of Financial Data Science.
   - 排名預測優於收益預測

4. **López de Prado, M. (2018)**. *Advances in Financial Machine Learning*. Wiley.
   - Walk-Forward 驗證
   - IC Decay 分析

5. **Harvey, C. R., Liu, Y., & Zhu, H. (2016)**. *...and the Cross-Section of Expected Returns*. Review of Financial Studies.
   - 統計顯著性標準

### C. 原始數據表

#### Valid IC 分佈

| 統計量 | 數值 |
|--------|------|
| 平均值 | 0.0273 |
| 標準差 | 0.0147 |
| 中位數 | 0.0289 |
| Q1 | 0.0190 |
| Q3 | 0.0378 |
| 最小值 | -0.0056 |
| 最大值 | 0.0599 |
| 偏度 | -0.31 |
| 峰度 | 0.00 |

#### Live IC 分佈

| 統計量 | 數值 |
|--------|------|
| 平均值 | 0.0102 |
| 標準差 | 0.0608 |
| 中位數 | 0.0186 |
| Q1 | -0.0216 |
| Q3 | 0.0523 |
| 最小值 | -0.1628 |
| 最大值 | 0.1117 |
| 偏度 | -0.91 |
| 峰度 | 0.77 |

#### 超額報酬分佈

| 統計量 | 數值 |
|--------|------|
| 平均週報酬 | 0.96% |
| 標準差 | 2.09% |
| 勝週率 | 63.3% |
| 累積報酬 | 87.25% |
| t 統計量 | 3.22 |
| p 值 | 0.002 |
