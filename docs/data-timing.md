# 資料更新時間與歷史範圍分析

測試時間：2026-01-29 16:37 (收盤後)

---

## 一、資料更新延遲

### 當天可取得（無延遲）

| 資料 | 來源 | 預估更新時間 |
|------|------|-------------|
| 日K線 | TWSE | ~15:00 |
| 日K線 | FinMind | ~17:30 |
| 日K線 | yfinance | ~15:30 |
| 三大法人 | TWSE | **~16:30** |
| 融資融券 | TWSE | ~15:30 |
| 期貨日成交 | FinMind | 當天 |

### 延遲 1 天（T+1）

| 資料 | 來源 | 說明 |
|------|------|------|
| 三大法人 | FinMind | TWSE 當天有，FinMind 延遲 |
| 融資融券 | FinMind | 同上 |
| 外資持股 | FinMind | 延遲 1 天 |
| PER/PBR | FinMind | 延遲 1 天 |

### 延遲較長

| 資料 | 延遲 | 說明 |
|------|------|------|
| 月營收 | ~10 天 | 每月 10 日前公布 |
| 財報 | 季度 | 財報公布後更新 |
| 除權息結果 | 事件後 | 除權息日後更新 |
| 原油 WTI | ~9 天 | 最新 1/20，今天 1/29 |

---

## 二、歷史資料範圍

### 完整歷史（有 10+ 年）

| 資料 | 起始日期 | 來源 | 筆數(2330) |
|------|----------|------|------------|
| 日K線 | 1994-09 | FinMind | 7,931 |
| 日K線(還原) | 2000-01 | yfinance | 6,489 |
| 融資融券 | 2001-01 | FinMind | 6,172 |
| 月營收 | 2002-02 | FinMind | 288 |
| 綜合損益表 | 1991-12 | FinMind | 2,133 |
| 除權息結果 | 2003-07 | FinMind | 43 |
| 期貨日成交 | 1998-07 | FinMind | 73,176 |

### 中等歷史（5-10 年）

| 資料 | 起始日期 | 來源 | 說明 |
|------|----------|------|------|
| PER/PBR | 2005-09 | FinMind | ~18 年 |

### 有限歷史（< 5 年）

| 資料 | 起始日期 | 來源 | 說明 |
|------|----------|------|------|
| 三大法人 | 2012-05 | FinMind | ~13 年 |
| 資產負債表 | 2012-03 | FinMind | ~13 年 |
| 現金流量表 | 2012-03 | FinMind | ~13 年 |
| 期貨三大法人 | 2018-06 | FinMind | ~7 年 |

---

## 三、資料處理策略

### 策略 A：即時性優先

適用：日K線、三大法人、融資融券

```
1. 每日 15:00 後嘗試 TWSE
2. 若失敗或延遲，等到 17:30 用 FinMind
3. 歷史資料用 FinMind 補全
```

### 策略 B：歷史完整性優先

適用：還原股價

```
1. 使用 yfinance 取得還原股價（有 Adj Close）
2. 歷史從 2000 年開始
```

### 策略 C：定期更新

適用：月營收、財報

```
1. 月營收：每月 1-10 日檢查更新
2. 財報：每季財報公布後更新（Q1:5月, Q2:8月, Q3:11月, Q4:3月）
```

---

## 四、為什麼會慢？

### 三大法人（TWSE vs FinMind）

| 時間 | TWSE | FinMind |
|------|------|---------|
| 16:07 | ❌ 無資料 | ❌ T-1 |
| 16:37 | ✅ 有資料 | ❌ T-1 |

**原因**：TWSE 在 16:00-16:30 才完成彙整並發布，FinMind 需等 TWSE 發布後再抓取處理。

### 原油 WTI（延遲 9 天）

- 最新資料：2026-01-20
- 今天日期：2026-01-29
- **原因**：FinMind 抓取國際資料來源，更新頻率較低

### 財報資料

- 需等公司公布後才有
- 法規規定：Q1-Q3 需在 45 天內公布，Q4 需在 3 個月內

---

## 五、資料來源選擇建議

| 資料類型 | 即時來源 | 歷史來源 | 說明 |
|----------|----------|----------|------|
| 日K線 | TWSE | FinMind | TWSE 快但僅當月 |
| 還原股價 | yfinance | yfinance | 唯一有 Adj Close |
| 三大法人 | TWSE(16:30後) | FinMind | TWSE 當天有 |
| 融資融券 | TWSE | FinMind | |
| PER/PBR | TWSE | FinMind | |
| 財報 | FinMind | FinMind | 已整合 MOPS |
| 期貨選擇權 | FinMind | FinMind | 已整合 TAIFEX |
| 匯率/黃金 | FinMind | FinMind | 獨有 |

---

## 六、資料分類與處理邏輯

### 分類依據

| 分類 | 更新頻率 | 歷史深度 | 處理方式 |
|------|----------|----------|----------|
| A | 每日 | 完整(10+年) | 初次全抓 + 每日增量 |
| B | 每日 | 有限(<10年) | 初次全抓 + 每日增量 |
| C | 每月 | 完整 | 月初檢查更新 |
| D | 每季 | 完整 | 季度檢查更新 |
| E | 不定期 | 完整 | 事件觸發更新 |

### 各資料分類

| 分類 | 資料 |
|------|------|
| A | 日K線、還原股價、融資融券、期貨日成交 |
| B | 三大法人、外資持股、PER/PBR、資產負債表、現金流量表 |
| C | 月營收 |
| D | 綜合損益表、資產負債表、現金流量表 |
| E | 除權息結果、減資/分割參考價 |

### 初次載入策略

```python
# 分類 A/B：全量載入
async def init_daily_data(dataset):
    # 1. 用 FinMind 抓完整歷史（慢但完整）
    history = await finmind.fetch(start='1990-01-01')

    # 2. 存入 DB
    repo.upsert(history)

# 分類 C/D/E：全量載入
async def init_periodic_data(dataset):
    # 直接用 FinMind 抓完整歷史
    history = await finmind.fetch(start='1990-01-01')
    repo.upsert(history)
```

### 每日更新策略

```python
async def daily_update(dataset):
    # 1. 查詢 DB 最新日期
    last_date = repo.get_latest_date(dataset)

    # 2. 判斷是否需要更新
    if last_date >= today:
        return  # 已是最新

    # 3. 根據分類選擇來源
    if is_category_a_or_b(dataset):
        # 先嘗試 TWSE（即時）
        if after_update_time(dataset):
            data = await twse.fetch(last_date, today)
        else:
            data = await finmind.fetch(last_date, today)

    # 4. 存入 DB
    repo.upsert(data)
```

### 更新時間表

| 資料 | 更新時間 | 來源切換 |
|------|----------|----------|
| 日K線 | 15:00 | TWSE → FinMind(17:30) |
| 三大法人 | 16:30 | TWSE → FinMind(隔天) |
| 融資融券 | 15:30 | TWSE → FinMind(17:30) |
| 月營收 | 每月 1-10 日 | FinMind only |
| 財報 | 季度公布後 | FinMind only |
