# 需求規格書

## 專案背景

- 使用 qlib 進行台股投資預測
- 需要部署與 UI 介面
- 執行環境：個人電腦（會關機，需自動開機機制）

## 核心規範

### 時間處理

- **統一使用台灣時間 (UTC+8)**
- 使用 `zoneinfo`（Python 3.9+ 內建）
- 時區標識：`Asia/Taipei`

### 因子挑選邏輯

採用 **IC 增量選擇法**：
1. 計算候選因子的 IC（Information Coefficient）
2. 若加入該因子後，模型整體 IC 提升 → 納入
3. 若無提升或下降 → 剔除

## 架構決策

### 技術棧

| 層級 | 技術 | 理由 |
|------|------|------|
| 前端 | React 18 + Vite | 元件生態成熟 ✅ |
| 後端 API | FastAPI | 現代 async、自動文檔、效能佳 ✅ |
| 資料庫 | SQLite | 簡單、無需服務、適合單機 ✅ |
| 預測引擎 | qlib | 指定 |
| 回測/績效 | qlib.backtest | qlib 內建，避免額外整合 |
| 排程（應用內） | APScheduler | Python 原生、輕量 |
| 排程（系統級） | Windows Task Scheduler | 開機自啟、系統原生 |
| 自動開機 | BIOS 定時開機 | 硬體層級、最可靠 |

### 主要套件

```
qlib          # 預測引擎、因子、回測
fastapi       # 後端 API
uvicorn       # ASGI 伺服器
apscheduler   # 應用內排程
httpx         # 非同步 HTTP（爬蟲）
sqlalchemy    # ORM
pytest        # 測試框架
pytest-asyncio # 非同步測試
```

### 前端套件 ✅

```
react 18      # 前端框架
vite          # 建置工具
tailwindcss   # 樣式
```

## 資料來源

| 來源 | 優先序 | 用途 | 特性 |
|------|--------|------|------|
| TWSE | 1 | 定期爬取 | 官方資料，只有近期 |
| FinMind | 2 | 補全歷史 | 完整歷史，有 API 限額 |

### 資料設計要求

- 資料源模組化（Adapter 模式）
- qlib 自行處理空值
- 支援 qlib 因子定義式
- 所有原始資料存 SQLite

## 因子系統

### 因子定義 ✅
- 因子表達式存資料庫
- 支援 qlib ExpressionOps 語法
- 30 個預設因子（技術面、籌碼面、估值、營收）

### 訓練結果
- 每次訓練記錄：選中的因子清單、各因子 IC 值
- 這是訓練輸出，非手動配置

## 訊號處理

- 預測訊號 → qlib.backtest 計算績效
- 輸出：收益率、夏普比率、最大回撤等

## 排程需求

| 任務 | 觸發 | 說明 |
|------|------|------|
| 資料補全 | 開機時 | 檢查並補全缺失資料 |
| 每日爬取 | 每日 18:00 | TWSE 收盤後抓取 |
| 模型預測 | 資料更新後 | 產生隔日訊號 |

## 自動開機方案

1. **BIOS 定時開機**：設定每日固定時間開機
2. **Windows Task Scheduler**：開機後自動啟動服務
3. **服務自檢**：啟動時檢查上次執行狀態，補執行遺漏任務

---

## 開發順序

1. 後端 API + 資料層
2. 排程系統
3. 測試覆蓋各功能
4. 前端 UI（最後）

## 已完成

- [x] FinMind API 金鑰取得
- [x] 資料同步（9 種資料集）
- [x] Qlib 導出器
- [x] 因子管理 API
- [x] 前端 UI
- [x] 模型訓練（LightGBM + IC 增量選擇）
- [x] 即時更新（WebSocket + Zustand）
